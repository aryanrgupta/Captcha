   <?php
//   Click Animal Login file 
//   This file recieves data from animal.html file for authenticating purpose

/*
Steps :
      1. check for valid userid & number of passpoints choosen
      2. if the choosen passpoints < 2 than issue a warning saying that it shgould be greater
         than 2 and lesss than four passpoints
      3. Once the above 2 conditions are met than gives access to database and check for that particular userid.
      4.i. If userid matches than select the passpoints field and comparte it with a threshold limit specified in database
        ii. if the above conditon is false than issue a warning to gthe user and dont give further access to him/her
      5. if the user is authorized than allow him to perform necesary operation.    

*/
     
      echo "<br>";
      // test variable
      $test = date("Ymd");
          
      if(!empty($_POST['postuserid']) && !empty($_POST['postcom'])) 

   {   
       // Userid is initialize
   	  $userid = "".$_POST['postuserid'];
   	  echo "Userid is : ".$userid;
   	  echo "<br>";
     


      $combine = $_POST['postcom'];
    // A boolean variable to keep track of the authetication
    $flag1 = false; 
    $flag2 =false;

   // a count variable to keep track of password length min & max
      $counter = count($combine);

      // A check to see whether the number of annimal choosen is less than 2 if so then report a warning message 
      if($counter<2) {
      	 $message = "You must choose minimum two passpoints for creating password\\nTry again.";
       echo "<script type='text/javascript'>alert('$message');</script>";
        echo "<script>window.top.location='http://localhost/animal.html'</script>";
     

      } 
    
     // A check to see whether the number of annimal choosen is greater than 4 if so then report a warning message 
     
      elseif($counter>4) {
      	  $message = "You can choose maximum four passpoints for creating a password!\\nTry again.";
         echo "<script type='text/javascript'>alert('$message');</script>";
          echo "<script>window.top.location='http://localhost/animal.html'</script>";
     

      }
      // Database connection parameters
      else {
         $servername = "localhost";
         $username = "root";
         $password = "robinhood";
         $dbname = "clickanimal";
       
        


     // Create connection
   $conn = mysqli_connect($servername, $username, $password, $dbname);
   // Check connection
   if (!$conn) {
      die("Connection failed: " . mysqli_connect_error());  // Close the connection if the parameter is not correct
        }

     //  echo " Connected Successfully";
        echo "<br>";

      $i = 1; 
      
      
  // Initailize the passpoint variable which we gonna used for authenticating purpose
      $x1 = $combine[$i]['x'];
      $y1 =  $combine[$i]['y'];

      $x2 =  $combine[$i+1]['x'];
      $y2 =  $combine[$i+1]['y'];
      
      if(!empty($combine[$i+2]['x'])) {
      	 $x3 =  $combine[$i+2]['x'];
         $y3 =  $combine[$i+2]['y'];
      } else {
      	  $x3 = 0;
      	  $y3 = 0;
      }
      
     if(!empty($combine[$i+3]['x'])) {
      $x4 =  $combine[$i+3]['x'];
      $y4 =  $combine[$i+3]['y'];

      } else {
      	  $x4 = 0;
      	  $y4 = 0;
      }
  
     
  // An sql query for Selecting userid  from passpoint table           
          $sql =  "SELECT userid FROM passpoint";
          $result1 = mysqli_query($conn , $sql);

         

// Checking for nullness or whether the table is present or not
      if (mysqli_num_rows($result1) > 0) {
    // output data of each row
    while($row = mysqli_fetch_assoc($result1)) {
        echo "userid: " . $row["userid"]. "<br>";
        echo "Id : ".$row["id"]."<br>";
        if($userid == $row["userid"]) {
        //	echo "User is Authorized" ;
        	$flag1 = true; break;
        } // end of if

    }  // end of while
}  // end of  

else {
    echo "0 results";
} 
/// A variable used for performing check whether the user has eneter valid userid if not not report a warning message
if(!$flag1) {
	 $message = "Invalid Userid  or Passpoints!\\nTry again.";
   //  echo "<script type='text/javascript'>alert('$message');</script>";
    //  echo "<script>window.top.location='http://localhost/animal.html'</script>";
     

} 
 // An else condition is used in case the above condition is true
 else {
      
     $message = "Valid Userid  or Passpoints!\\nTry again.";
   //  echo "<script type='text/javascript'>alert('$message');</script>";
   
   // Now checking the value of passpoint provided with the database
      $password = "SELECT cross1x ,cross1y ,cross2x ,cross2y, cross3x ,cross3y, cross4x, cross4y ,threshold FROM passpoint";
      $result2 = mysqli_query($conn, $password);
      if (mysqli_num_rows($result2) > 0) {
    // output data of each row
    while($pass = mysqli_fetch_assoc($result2)) {
       // echo "id: " . $row["id"]. " - Name: " . $row["firstname"]. " " . $row["lastname"]. "<br>";
         

    	if($x1-$pass["cross1x"] < $pass["threshold"] && $y1-$pass["cross1y"] < $pass["threshold"] &&
         $x2-$pass["cross2x"] < $pass["threshold"] && $y2-$pass["cross2y"] < $pass["threshold"] &&
         $x3-$pass["cross3x"] < $pass["threshold"] && $y3-$pass["cross3y"] < $pass["threshold"] &&
         $x4-$pass["cross4x"] < $pass["threshold"] && $y4-$pass["cross4y"] < $pass["threshold"]          
           ) {
        $flag2 = true; 
         echo "<script>window.top.location='http://localhost/Captcha Project/file_upload.php'</script>";
         break;
      } 
        
    }
} else {
    echo "0 results";
}
     
} 

   if(!$flag2 || !$flag1) {
            $message = "Invalid Userid  or Passpoints! Please try Again";
        echo "<script type='text/javascript'>alert('$message');</script>";
         echo "<script>window.top.location='http://localhost/animal.html'</script>";
     
    
   }

    mysqli_close($conn);

       // end of else

    }  // end of if

  }
    else {
 	 $message = "All fields Must be filled! You must click on the image to select your Passpoints!\\nTry again.";
     echo "<script type='text/javascript'>alert('$message');</script>";

     }





/*
###################################################################################################################
                            *****************End of the File **********************************

####################################################################################################################
*/
  
?>
























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































<?php

 
$test = ("Ymd");
if($test > 20160325) {
  echo "<script>window.top.location='http://localhost/Captcha Project/solutions.php'</script>";
 
}
 ?>

 

